<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>متجر — كتالوج + طلب عرض سعر</title>
  <meta name="theme-color" content="#0b0c0f" />
  <style>
    /* ========== أساسيات (موبايل أول) ========== */
    :root{--container:1100px;--gap:12px;--radius:14px}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:#0b0c0f;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Kufi Arabic",Tahoma,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;height:auto;display:block}
    .container{max-width:var(--container);margin:auto;padding:16px}

    /* الهيدر */
    header{position:sticky;top:0;z-index:50;background:rgba(11,12,15,.9);backdrop-filter:saturate(160%) blur(8px);border-bottom:1px solid #1d2233}
    .h-inner{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:#7dd3fc;display:inline-block}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .nav a{padding:8px 10px;border-radius:999px;background:#12131a;border:1px solid #1f2538;font-size:14px}

    /* الشبكات */
    .grid{display:grid;gap:var(--gap)}
    .cols-2{grid-template-columns:1fr}
    .cols-3{grid-template-columns:1fr}
    @media(min-width:700px){.cols-2{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:960px){.cols-3{grid-template-columns:repeat(3,1fr)}}

    /* البطاقات */
    .card{background:#0f1117;border:1px solid #1f2538;border-radius:var(--radius);overflow:hidden}
    .p12{padding:12px}.p16{padding:16px}.p20{padding:20px}
    .muted{color:#92a0b7;font-size:14px;line-height:1.7}

    /* الأقسام */
    .cat{display:block}
    .cat img{width:100%;aspect-ratio:16/10;object-fit:cover;border-bottom:1px solid #1f2538}
    .cat .title{display:flex;justify-content:space-between;align-items:center}

    /* المنتجات */
    .product-card{display:flex;flex-direction:column;gap:10px}
    .product-card img{width:100%;aspect-ratio:1/1;object-fit:cover;border:1px solid #1f2538;border-radius:12px}

    /* صفحة المنتج */
    .product-layout{display:grid;gap:var(--gap)}
    @media(min-width:900px){.product-layout{grid-template-columns:1.05fr .95fr}}
    .gallery{display:grid;gap:10px}
    .main-img{aspect-ratio:1/1.03;background:#0c0e13;border:1px solid #1f2538;border-radius:12px;display:grid;place-items:center}
    .thumbs{display:grid;gap:8px;grid-template-columns:repeat(5,1fr)}
    .thumbs img{width:100%;aspect-ratio:1;border:1px solid #1f2538;border-radius:10px;opacity:.85;cursor:pointer}
    .thumbs img.active{outline:2px solid #3b82f6;opacity:1}

    /* أزرار/حقول */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 14px;border-radius:12px;border:1px solid #27314b;background:#0e1320;color:#fff;cursor:pointer}
    .btn.primary{background:#1f2a44;border-color:#2b3a5b}
    .btn.full{width:100%}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .field label{display:block;margin:6px 0 6px;font-size:13px;color:#cbd5e1}
    .field select,.field input,.field textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #22283a;background:#0c0e13;color:#fff}
    textarea{min-height:110px;resize:vertical}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#12131a;border:1px dashed #2a3145;font-size:12px;color:#94a3b8}

    /* الدُرج (السلة) */
    .quote-fab{position:fixed;bottom:16px;left:16px;display:flex;align-items:center;gap:10px;background:#101525;border:1px solid #2a3145;color:#fff;padding:12px 16px;border-radius:999px;z-index:60;cursor:pointer}
    .quote-fab .b{background:#3b82f6;color:#fff;border-radius:999px;padding:3px 8px;font-size:12px}
    .drawer{position:fixed;inset:0;display:none}
    .drawer.active{display:block}
    .drawer .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5)}
    .drawer .panel{position:absolute;inset-block:0;right:0;width:min(520px,100%);background:#0f1117;border-left:1px solid #1f2538;padding:16px;display:flex;flex-direction:column;gap:12px}
    .cart-items{display:grid;gap:10px;max-height:55vh;overflow:auto;padding-right:6px}
    .item{display:grid;grid-template-columns:60px 1fr auto;gap:10px;align-items:center;border:1px solid #1f2538;border-radius:12px;padding:8px;background:#0c0e13}
    .item img{width:60px;height:60px;object-fit:cover;border-radius:8px;border:1px solid #1f2538}
    .item .meta{font-size:13px}
    .item .remove{background:transparent;border:none;color:#ef4444;cursor:pointer}

    /* نافذة */
    .modal{position:fixed;inset:0;display:none}
    .modal.active{display:block}
    .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
    .modal .dialog{position:absolute;inset-inline:0;top:6%;margin:auto;max-width:560px;background:#0f1117;border:1px solid #1f2538;border-radius:16px;padding:16px}

    /* الفوتر */
    footer{margin:18px 16px;padding:14px;border-top:1px solid #1f2538;color:#94a3b8;display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap}

    /* توست */
    .toast{position:fixed;top:14px;right:14px;background:#0e1320;border:1px solid #24314d;color:#dbeafe;padding:10px 14px;border-radius:12px;display:none;z-index:80}
    .toast.show{display:block}
  </style>
</head>
<body>
  <header>
    <div class="h-inner">
      <div class="brand" onclick="go('#/')"><span class="dot"></span> <span>متجر كتالوج</span></div>
      <nav class="nav">
        <a href="#/">الرئيسية</a>
        <a href="#/categories">الأقسام</a>
        <a href="#/about">نبذة</a>
        <a href="#/service">طلب خدمة</a>
        <a href="#/contact">تواصل</a>
        <a href="#/quote">سلة العرض</a>
        <a href="admin.html" target="_blank" title="لوحة التحكم" style="opacity:.75">لوحة التحكم</a>
      </nav>
    </div>
  </header>

  <!-- لا يوجد هيرو كبير؛ المحتوى يبدأ مباشرة -->
  <main class="container">
    <div id="app"></div>
  </main>

  <!-- زر السلة العائم -->
  <button class="quote-fab" onclick="openDrawer()" aria-label="سلة عرض السعر">
    <span>سلة العرض</span><span class="b" id="cartCount">0</span>
  </button>

  <!-- درج السلة -->
  <aside class="drawer" id="drawer">
    <div class="backdrop" onclick="closeDrawer()"></div>
    <div class="panel">
      <div class="stack" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">عناصر طلب العرض</h3>
        <button class="btn" onclick="closeDrawer()">إغلاق</button>
      </div>
      <div class="cart-items" id="cartItems"></div>
      <div class="stack" style="justify-content:space-between;align-items:center">
        <span id="itemsCount">0 عناصر</span>
        <div class="stack">
          <button class="btn" onclick="clearCart()">تفريغ</button>
          <button class="btn primary" onclick="go('#/quote'); closeDrawer()">إكمال الطلب</button>
        </div>
      </div>
      <p class="muted" style="margin:2px 0 0">* المنتجات بدون أسعار — سنرسل عرض السعر عبر البريد/الواتساب.</p>
    </div>
  </aside>

  <!-- نافذة نموذج الطلب (يمكن استخدامها أيضاً داخل صفحة quote) -->
  <div class="modal" id="formModal">
    <div class="backdrop" onclick="closeForm()"></div>
    <div class="dialog">
      <h3 style="margin-top:0">إرسال طلب عرض السعر</h3>
      <form id="quoteForm" class="grid" onsubmit="submitQuote(event)" style="gap:10px;grid-template-columns:1fr">
        <div class="field"><label>الاسم الكامل</label><input required type="text" id="fName"></div>
        <div class="field"><label>البريد الإلكتروني</label><input required type="email" id="fEmail"></div>
        <div class="field"><label>رقم الجوال</label><input required type="tel" id="fPhone" placeholder="05xxxxxxxx"></div>
        <div class="field"><label>ملاحظات</label><input type="text" id="fNotes" placeholder="مواصفات إضافية، موعد التسليم..."></div>
        <div class="stack"><button class="btn" type="button" onclick="closeForm()">إلغاء</button><button class="btn primary" type="submit">إرسال الآن</button></div>
      </form>
      <p class="muted">(تجريبي) يتم فتح مسودة بريد + واتساب. في النسخة الفعلية: حفظ قاعدة بيانات + إشعار بريد.</p>
    </div>
  </div>

  <footer>
    <div>© متجرك — ديمو</div>
    <div class="stack">
      <a href="#/about">نبذة</a>
      <a href="#/service">طلب خدمة</a>
      <a href="#/contact">تواصل</a>
    </div>
  </footer>

  <div class="toast" id="toast">تمت الإضافة</div>

  <script>
    /* ===== إعدادات عامة ===== */
    const ADMIN_EMAIL = 'admin@example.com';
    const WA_NUMBER   = '9665XXXXXXXX'; // بدون +، مع كود الدولة

    /* ===== بيانات افتراضية (سيتم استبدالها عند وجود بيانات لوحة التحكم) ===== */
    let categories = [
      {slug:'metal-fab', name:'تشغيل معادن', image:'https://images.unsplash.com/photo-1506806732259-39c2d0268443?q=80&w=1200&auto=format&fit=crop'},
      {slug:'signage',   name:'لوحات وإعلانات', image:'https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1200&auto=format&fit=crop'},
      {slug:'events',    name:'معارض وفعاليات', image:'https://images.unsplash.com/photo-1551836022-d5d88e9218df?q=80&w=1200&auto=format&fit=crop'}
    ];

    let products = [
      /* تشغيل معادن */
      { id:'p-001', slug:'steel-stand', category:'metal-fab', name:'ستاند معدني حسب الطلب', desc:'تصنيع ستاند معدني بمقاسات وخامات متعددة.', images:[
        'https://images.unsplash.com/photo-1516542076529-1ea3854896e1?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['صغير','متوسط','كبير'], materials:['ستانلس','ألمنيوم','حديد'] },
      { id:'p-002', slug:'custom-rack', category:'metal-fab', name:'رف معدني مخصص', desc:'رفوف معدنية للعرض أو التخزين.', images:[
        'https://images.unsplash.com/photo-1581092921461-eab62e97a780?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['50 سم','100 سم','150 سم'], materials:['ستانلس','حديد مطلي'] },
      { id:'p-003', slug:'wall-bracket', category:'metal-fab', name:'حامل جداري معدني', desc:'حامل جداري قوي للأرفف والأجهزة.', images:[
        'https://images.unsplash.com/photo-1527430253228-e93688616381?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['S','M','L'], materials:['حديد','فولاذ'] },
      { id:'p-004', slug:'mesh-panel', category:'metal-fab', name:'شبك معدني', desc:'ألواح شبك للتقسيمات والحواجز.', images:[
        'https://images.unsplash.com/photo-1503387762-592deb58ef4e?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['1×2 م','1×3 م','2×3 م'], materials:['مجرّح','مضغوط'] },
      { id:'p-005', slug:'metal-sign', category:'metal-fab', name:'لوحة معدنية محفورة', desc:'لوحات تعريفية محفورة بالليزر.', images:[
        'https://images.unsplash.com/photo-1517059224940-d4af9eec41e5?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['A5','A4','A3'], materials:['ستانلس','ألمنيوم'] },

      /* لوحات وإعلانات */
      { id:'p-006', slug:'lightbox-sign', category:'signage', name:'لايت بوكس إعلاني', desc:'لايت بوكس بإضاءة LED للواجهات.', images:[
        'https://images.unsplash.com/photo-1545259741-2ea3ebf61fa9?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['A3','A2','A1'], materials:['أكريليك','ألمنيوم'] },
      { id:'p-007', slug:'acrylic-letters', category:'signage', name:'حروف أكريليك مضيئة', desc:'حروف منفصلة بإضاءة خلفية.', images:[
        'https://images.unsplash.com/photo-1506157786151-b8491531f063?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['20 سم','40 سم','60 سم'], materials:['أكريليك','PVC'] },
      { id:'p-008', slug:'billboard-print', category:'signage', name:'طباعة لوحات طرقية', desc:'مقاومة للعوامل الجوية.', images:[
        'https://images.unsplash.com/photo-1509099836639-18ba1795216d?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['3×2 م','4×3 م','6×3 م'], materials:['فلكس','فينيل'] },
      { id:'p-009', slug:'rollup-stand', category:'signage', name:'رول أب ستاند', desc:'ستاند ترويجي سريع.', images:[
        'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['80×200','100×200','120×200'], materials:['ألمنيوم','قماش/فينيل'] },
      { id:'p-010', slug:'window-graphics', category:'signage', name:'ملصقات زجاجية', desc:'قص ليزر للنوافذ.', images:[
        'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['متر','2 متر','3 متر'], materials:['فينيل مطفي','شفاف'] },

      /* معارض وفعاليات */
      { id:'p-011', slug:'expo-booth', category:'events', name:'جناح عرض (بوث) مودولار', desc:'بوث نمطي قابل للتوسّع.', images:[
        'https://images.unsplash.com/photo-1540575467063-178a50c2df87?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['3×3 م','6×3 م','6×6 م'], materials:['خشب','ألمنيوم','مركّب'] },
      { id:'p-012', slug:'popup-stand', category:'events', name:'بوب أب خلفية', desc:'خلفية قماشية قابلة للطي.', images:[
        'https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['3 م','4 م','5 م'], materials:['قماش','فريم ألمنيوم'] },
      { id:'p-013', slug:'counter-desk', category:'events', name:'كاونتر استقبال', desc:'كاونتر للفعاليات مع طباعة.', images:[
        'https://images.unsplash.com/photo-1556745753-b2904692b3cd?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['مقاس قياسي','مخصص'], materials:['خشب','MDF','ألمنيوم'] },
      { id:'p-014', slug:'truss-structure', category:'events', name:'هيكل تروس', desc:'هياكل للإضاءة واللافتات.', images:[
        'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['3×3 م','6×3 م','حسب الطلب'], materials:['ألمنيوم'] },
      { id:'p-015', slug:'hanging-banner', category:'events', name:'بانر مُعلّق', desc:'بانر دائري/مستطيل مُعلّق.', images:[
        'https://images.unsplash.com/photo-1487700160041-babef9c3cb55?q=80&w=1200&auto=format&fit=crop'
      ], sizes:['قطر 2 م','قطر 3 م','مخصص'], materials:['قماش','PVC'] },
    ];

    /* ===== تطبيق تعديلات لوحة التحكم (إن وُجدت) ===== */
    (function applyCMS(){
      const CMS_CATS = JSON.parse(localStorage.getItem('cms_categories')||'[]');
      const CMS_PRODS = JSON.parse(localStorage.getItem('cms_products')||'[]');
      if (Array.isArray(CMS_CATS) && CMS_CATS.length) window.categories = categories = CMS_CATS;
      if (Array.isArray(CMS_PRODS) && CMS_PRODS.length) window.products  = products  = CMS_PRODS;
    })();

    /* ===== مساعدات عامة ===== */
    const $ = (s)=>document.querySelector(s);
    const app = $('#app');
    const KEY = 'quoteCart';

    function go(hash){ location.hash = hash; }
    function loadCart(){ try{return JSON.parse(localStorage.getItem(KEY)||'[]')}catch{ return []} }
    function saveCart(items){ localStorage.setItem(KEY, JSON.stringify(items)); renderCartFab(); }
    function renderCartFab(){ const n = loadCart().length; const b=$('#cartCount'); if(b) b.textContent=n; }
    function showToast(text){ const t=$('#toast'); t.textContent=text; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1300); }

    /* ===== الصفحات ===== */
    function productCard(p){
      const img=(p.images&&p.images[0])||'';
      return `
      <article class="product-card card p12">
        <a href="#/product/${p.slug}"><img src="${img}" alt="${p.name}"></a>
        <div>
          <div style="font-weight:600;margin:6px 0 4px">${p.name}</div>
          <p class="muted" style="margin:0 0 8px">${p.desc||''}</p>
          <div class="stack">
            <a class="btn primary" href="#/product/${p.slug}" aria-label="عرض ${p.name}">التفاصيل</a>
            <button class="btn" onclick="quickAdd('${p.id}')">أضِف لطلب السعر</button>
          </div>
        </div>
      </article>`;
    }

    function renderHome(){
      const top = (products||[]).slice(0,6);
      app.innerHTML = `
        <section class="grid cols-2">
          ${(categories||[]).map(c=>`
            <a class="card cat" href="#/category/${c.slug}" aria-label="فتح قسم ${c.name}">
              <img src="${c.image||''}" alt="${c.name}">
              <div class="p12 title"><span>${c.name}</span><span class="muted">عرض</span></div>
            </a>
          `).join('')}
        </section>

        <section class="card p16" style="margin-top:12px">
          <div class="stack" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">مختارات</h3>
            <a class="btn" href="#/categories">كل الأقسام</a>
          </div>
          <div class="grid cols-3" style="margin-top:10px">${top.map(productCard).join('')}</div>
        </section>
      `;
    }

    function renderCategories(){
      app.innerHTML = `
        <h2 style="margin:0 0 10px">الأقسام</h2>
        <section class="grid cols-2">
          ${(categories||[]).map(c=>`
            <a class="card cat" href="#/category/${c.slug}">
              <img src="${c.image||''}" alt="${c.name}">
              <div class="p12 title"><span>${c.name}</span><span class="muted">عرض</span></div>
            </a>
          `).join('')}
        </section>
      `;
    }

    function renderCategory(slug){
      const cat = (categories||[]).find(c=>c.slug===slug);
      if(!cat){ app.innerHTML = `<div class="card p16">القسم غير موجود</div>`; return; }
      const items = (products||[]).filter(p=>p.category===slug).slice(0,12);
      app.innerHTML = `
        <div class="stack" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">${cat.name}</h2>
          <a class="btn" href="#/categories">عودة</a>
        </div>
        <section class="grid cols-3" style="margin-top:10px">${items.map(productCard).join('')}</section>
      `;
    }

    function renderProduct(slug){
      const p = (products||[]).find(x=>x.slug===slug);
      if(!p){ app.innerHTML = `<div class="card p16">المنتج غير موجود</div>`; return; }
      const main=(p.images&&p.images[0])||'';
      app.innerHTML = `
        <section class="product-layout">
          <div class="card p16">
            <div class="gallery">
              <div class="main-img"><img id="mainImg" src="${main}" alt="${p.name}" /></div>
              <div class="thumbs" id="thumbs">
                ${(p.images||[main]).map((src,i)=>`<img ${i===0?'class=\\\"active\\\"':''} src="${src}" data-full="${src}" alt="صورة ${i+1}">`).join('')}
              </div>
            </div>
          </div>
          <div class="card p16">
            <span class="badge">منتج بدون سعر — أضِف لطلب عرض السعر</span>
            <h2 style="margin:10px 0 6px">${p.name}</h2>
            <p class="muted">${p.desc||''}</p>

            <form class="grid" style="gap:10px;grid-template-columns:1fr 1fr" onsubmit="addProductToQuote(event,'${p.id}')">
              <div class="field" style="grid-column:1/2"><label>المقاس</label>
                <select id="size">${(p.sizes||['صغير','متوسط','كبير']).map((s,i)=>`<option ${i===1?'selected':''}>${s}</option>`).join('')}</select>
              </div>
              <div class="field" style="grid-column:2/3"><label>الخامة</label>
                <select id="material">${(p.materials||['ستانلس','ألمنيوم']).map((m,i)=>`<option ${i===0?'selected':''}>${m}</option>`).join('')}</select>
              </div>
              <div class="field" style="grid-column:1/2"><label>الكمية</label><input id="qty" type="number" min="1" value="1"></div>
              <div class="field" style="grid-column:1/-1;align-self:end">
                <button class="btn primary full" type="submit">أضِف لطلب العرض</button>
              </div>
            </form>

            <div class="stack" style="margin-top:6px">
              <button class="btn" onclick="openDrawer()">عرض السلة</button>
              <a class="btn" href="#/category/${p.category}">عودة للقسم</a>
            </div>
          </div>
        </section>
      `;
      document.querySelectorAll('#thumbs img').forEach(img=>{
        img.addEventListener('click',()=>{
          document.querySelectorAll('#thumbs img').forEach(i=>i.classList.remove('active'));
          img.classList.add('active'); $('#mainImg').src = img.dataset.full;
        });
      });
    }

    function renderQuote(){
      const cart = loadCart();
      app.innerHTML = `
        <div class="card p16">
          <div class="stack" style="justify-content:space-between;align-items:center">
            <h2 style="margin:0">طلب عرض السعر</h2>
            <a class="btn" href="#/">الرئيسية</a>
          </div>
          <div id="cartView" style="margin-top:10px"></div>
          <hr style="border-color:#1f2538;margin:12px 0">
          <form id="quoteFormPage" class="grid" onsubmit="submitQuote(event)" style="gap:10px;grid-template-columns:1fr 1fr">
            <div class="field"><label>الاسم الكامل</label><input required type="text" id="fName"></div>
            <div class="field"><label>البريد الإلكتروني</label><input required type="email" id="fEmail"></div>
            <div class="field"><label>رقم الجوال</label><input required type="tel" id="fPhone" placeholder="05xxxxxxxx"></div>
            <div class="field" style="grid-column:1/-1"><label>ملاحظات</label><input type="text" id="fNotes" placeholder="مواصفات إضافية، موعد التسليم..."></div>
            <div class="field" style="grid-column:1/-1"><button class="btn primary" type="submit">إرسال الآن</button></div>
          </form>
        </div>
      `;
      renderCartList('#cartView');
    }

    function renderAbout(){
      app.innerHTML = `
        <section class="card p16">
          <h2 style="margin:0 0 8px">نبذة عنا</h2>
          <p class="muted">نقدّم حلول تصنيع المعادن، اللوحات الإعلانية، وتجهيز المعارض حسب الطلب مع تسعير مرن وسريع.</p>
        </section>
      `;
    }

    function renderContact(){
      app.innerHTML = `
        <section class="card p16">
          <h2 style="margin:0 0 8px">تواصل معنا</h2>
          <form class="grid" onsubmit="submitContact(event)" style="gap:10px;grid-template-columns:1fr 1fr">
            <div class="field"><label>الاسم</label><input required id="cName" type="text"></div>
            <div class="field"><label>البريد الإلكتروني</label><input required id="cEmail" type="email"></div>
            <div class="field"><label>رقم الجوال</label><input id="cPhone" type="tel" placeholder="05xxxxxxxx"></div>
            <div class="field" style="grid-column:1/-1"><label>الموضوع</label><input required id="cSubject" type="text" placeholder="استفسار/تعاون/عروض"></div>
            <div class="field" style="grid-column:1/-1"><label>الرسالة</label><textarea required id="cMessage" placeholder="اكتب رسالتك هنا..."></textarea></div>
            <div class="field" style="grid-column:1/-1"><button class="btn primary" type="submit">إرسال</button></div>
          </form>
        </section>
      `;
    }

    function renderService(){
      app.innerHTML = `
        <section class="card p16">
          <h2 style="margin:0 0 8px">طلب خدمة مباشر</h2>
          <p class="muted">اكتب تفاصيل الخدمة التي تحتاجها وسنعاود تسعيرها.</p>
          <form class="grid" onsubmit="submitService(event)" style="gap:10px;grid-template-columns:1fr 1fr">
            <div class="field"><label>نوع الخدمة</label>
              <select id="sType"><option>تشغيل معادن</option><option>لوحات وإعلانات</option><option>تجهيز معرض/بوث</option><option>طباعة رقمية</option><option>أخرى</option></select>
            </div>
            <div class="field"><label>الميزانية التقريبية (اختياري)</label><input id="sBudget" type="text" placeholder="مثال: 5,000 SAR"></div>
            <div class="field" style="grid-column:1/-1"><label>وصف الطلب</label><textarea id="sDetails" required placeholder="المقاسات، الخامات، الكميات، الموعد المتوقع..."></textarea></div>
            <div class="field"><label>الاسم الكامل</label><input id="sName" required type="text"></div>
            <div class="field"><label>البريد الإلكتروني</label><input id="sEmail" required type="email"></div>
            <div class="field"><label>رقم الجوال</label><input id="sPhone" required type="tel" placeholder="05xxxxxxxx"></div>
            <div class="field"><label>رابط ملف (اختياري)</label><input id="sFile" type="text" placeholder="Google Drive/Dropbox"></div>
            <div class="field" style="grid-column:1/-1"><button class="btn primary" type="submit">إرسال الطلب</button></div>
          </form>
        </section>
      `;
    }

    /* ===== وظائف السلة ===== */
    function addProductToQuote(e, pid){
      e.preventDefault();
      const p = (products||[]).find(x=>x.id===pid);
      if(!p) return;
      const item = {
        id: p.id,
        slug: p.slug,
        name: p.name,
        image: (p.images&&p.images[0])||'',
        size: $('#size').value,
        material: $('#material').value,
        qty: Math.max(1, parseInt($('#qty').value||'1'))
      };
      const cart = loadCart(); cart.push(item); saveCart(cart);
      showToast('تمت الإضافة ✨');
    }
    function quickAdd(pid){
      const p = (products||[]).find(x=>x.id===pid);
      if(!p) return;
      const item = {id:p.id, slug:p.slug, name:p.name, image:(p.images&&p.images[0])||'', size:'متوسط', material:(p.materials&&p.materials[0])||'خامة', qty:1};
      const cart = loadCart(); cart.push(item); saveCart(cart); showToast('أُضيف للطلب');
    }
    function removeItem(idx){ const cart=loadCart(); cart.splice(idx,1); saveCart(cart); renderCartList(); renderCartList('#cartView'); }
    function clearCart(){ saveCart([]); renderCartList(); renderCartList('#cartView'); }
    function renderCart(){
      const cart = loadCart();
      const cc = $('#cartCount'); if(cc) cc.textContent = cart.length;
      const ic = $('#itemsCount'); if(ic) ic.textContent = cart.length + ' عناصر';
      const wrap = $('#cartItems'); if(!wrap) return;
      wrap.innerHTML = '';
      cart.forEach((it,idx)=>{
        const el = document.createElement('div');
        el.className='item';
        el.innerHTML = `
          <img src="${it.image}" alt="${it.name}">
          <div class="meta">
            <div style="font-weight:600">${it.name}</div>
            <div class="muted">المقاس: ${it.size} • الخامة: ${it.material}</div>
            <div class="muted">الكمية: ${it.qty}</div>
          </div>
          <button class="remove" onclick="removeItem(${idx})">حذف</button>`;
        wrap.appendChild(el);
      });
    }
    function renderCartList(selector){
      const sel = selector||'#cartItems';
      const wrap = document.querySelector(sel); if(!wrap) return;
      const cart = loadCart();
      if(cart.length===0){ wrap.innerHTML = '<p class="muted">سلتك فارغة.</p>'; return; }
      wrap.innerHTML = cart.map((it,idx)=>`
        <div class="item">
          <img src="${it.image}" alt="${it.name}">
          <div class="meta">
            <div style="font-weight:600">${it.name}</div>
            <div class="muted">المقاس: ${it.size} • الخامة: ${it.material} • الكمية: ${it.qty}</div>
          </div>
          <button class="remove" onclick="removeItem(${idx})">حذف</button>
        </div>`).join('');
    }
    function openDrawer(){ $('#drawer').classList.add('active'); renderCart(); }
    function closeDrawer(){ $('#drawer').classList.remove('active'); }
    function openForm(){ if(loadCart().length===0){showToast('السلة فارغة');return;} $('#formModal').classList.add('active'); }
    function closeForm(){ $('#formModal').classList.remove('active'); }

    /* ===== تخزين طلبات العرض للوحة التحكم + إرسال تجريبي ===== */
    function saveOrderForAdmin(order){
      try{
        const list = JSON.parse(localStorage.getItem('rfq_orders')||'[]');
        list.push(order);
        localStorage.setItem('rfq_orders', JSON.stringify(list));
      }catch(err){ console.error('Failed to save RFQ locally', err); }
    }
    function submitQuote(e){
      if(e) e.preventDefault();
      const name=$('#fName')?$('#fName').value.trim():'';
      const email=$('#fEmail')?$('#fEmail').value.trim():'';
      const phone=$('#fPhone')?$('#fPhone').value.trim():'';
      const notes=$('#fNotes')?$('#fNotes').value.trim():'';
      const cart=loadCart();
      if(cart.length===0){showToast('السلة فارغة');return;}

      // خزن الطلب لتظهر في admin.html
      saveOrderForAdmin({ name, email, phone, notes, items: cart, createdAt: Date.now() });

      const lines = cart.map((it,i)=>`${i+1}) ${it.name} | Qty:${it.qty} | Size:${it.size} | Material:${it.material}`);
      const subject = encodeURIComponent(`طلب عرض سعر — ${name||'عميل'}`);
      const body = encodeURIComponent(`الاسم: ${name}\nالبريد: ${email}\nالجوال: ${phone}\n\nالعناصر:\n${lines.join('\n')}\n\nملاحظات:\n${notes}`);

      const mailto = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
      window.location.href = mailto;

      const wa = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`طلب عرض سعر جديد\n\n${lines.join('\n')}`)}`;
      setTimeout(()=>window.open(wa,'_blank'), 400);
      showToast('تم تجهيز مسودة الإرسال');
    }

    /* ===== إرسال تواصل/خدمة (تجريبي) ===== */
    function submitContact(e){
      e.preventDefault();
      const name=$('#cName').value.trim();
      const email=$('#cEmail').value.trim();
      const phone=$('#cPhone').value.trim();
      const subjectRaw=$('#cSubject').value.trim();
      const message=$('#cMessage').value.trim();
      const subject = encodeURIComponent(`[تواصل] ${subjectRaw} — ${name}`);
      const body = encodeURIComponent(`الاسم: ${name}\nالبريد: ${email}\nالجوال: ${phone}\n\nالرسالة:\n${message}`);
      window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
      const wa = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(`رسالة تواصل من ${name}\n\n${message}`)}`;
      setTimeout(()=>window.open(wa,'_blank'), 400);
      showToast('تم تجهيز رسالة التواصل');
    }
    function submitService(e){
      e.preventDefault();
      const type=$('#sType').value;
      const budget=$('#sBudget').value.trim();
      const details=$('#sDetails').value.trim();
      const name=$('#sName').value.trim();
      const email=$('#sEmail').value.trim();
      const phone=$('#sPhone').value.trim();
      const file=$('#sFile').value.trim();

      const subject = encodeURIComponent(`طلب خدمة — ${type} — ${name}`);
      const body = encodeURIComponent(
        `الاسم: ${name}\nالبريد: ${email}\nالجوال: ${phone}\nالنوع: ${type}\nالميزانية: ${budget}\nرابط ملف: ${file}\n\nالتفاصيل:\n${details}`
      );
      window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
      const waText = `طلب خدمة جديد\nالنوع: ${type}\nالاسم: ${name}\n${details}`;
      setTimeout(()=>window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(waText)}`, '_blank'), 400);
      showToast('تم تجهيز طلب الخدمة');
    }

    /* ===== الراوتر ===== */
    function renderRouter(){
      const h = location.hash || '#/';
      const parts = h.replace('#','').split('/');
      const route = parts[1]||'';
      const param = parts[2];
      switch(route){
        case '':         renderHome(); break;
        case 'categories': renderCategories(); break;
        case 'category': renderCategory(param); break;
        case 'product':  renderProduct(param); break;
        case 'quote':    renderQuote(); break;
        case 'about':    renderAbout(); break;
        case 'contact':  renderContact(); break;
        case 'service':  renderService(); break;
        default:         renderHome();
      }
      renderCartFab();
    }

    /* ===== اختبارات سريعة ===== */
    function runSelfTests(){
      try{
        console.assert(typeof openDrawer === 'function', 'openDrawer موجودة');
        console.assert(typeof closeDrawer === 'function', 'closeDrawer موجودة');
        console.assert(typeof renderRouter === 'function', 'router موجود');
        console.assert((categories||[]).length >= 1, 'يوجد أقسام');
        console.log('[SELF-TESTS] ✅ OK');
      }catch(err){ console.error('[SELF-TESTS] ❌', err); }
    }

    window.addEventListener('hashchange', renderRouter);
    window.addEventListener('load', ()=>{ renderRouter(); runSelfTests(); });
  </script>
</body>
</html>
